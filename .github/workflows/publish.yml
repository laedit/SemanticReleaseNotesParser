name: Publish

on:
  push:
    tags:
      - v*
      
jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v2

    - name: Fetch all history for all tags and branches
      run: git fetch --prune --unshallow

    - uses: actions/cache@v2
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.x

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0.9.2
      with:
          versionSpec: '5.2.x'

    - name: Use GitVersion
      id: gitversion # step id used as reference for output values
      uses: gittools/actions/gitversion/execute@v0.9.2

    - run: echo "NuGetVersionV2: ${{ steps.gitversion.outputs.nuGetVersionV2 }}"

    - name: Install dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

   # - name: Test #skip?
    #  run: dotnet test --no-build --verbosity normal

    #  - name: Build and publish
    #    run: |
    #      dotnet pack -o output src/DotnetVersion/DotnetVersion.csproj
    #      dotnet nuget push src/DotnetVersion/output/ -s https://nuget.org -k ${NUGET_API_KEY}
        # env:
          # NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}